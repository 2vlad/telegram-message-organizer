import { Message, Chat, User } from 'telegram/tl/types';

/**
 * –¢–∏–ø—ã —á–∞—Ç–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏
 */
export enum ChatType {
  PERSONAL = 'personal',
  NEWS = 'news',
  DISCUSSION = 'discussion',
  UNKNOWN = 'unknown'
}

/**
 * –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —á–∞—Ç–æ–≤
 */
const CHANNEL_PATTERNS = /channel|–∫–∞–Ω–∞–ª|news|–Ω–æ–≤–æ—Å—Ç|–±–ª–æ–≥|blog|official|–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω|feed|–±–æ—Ç|bot|service|telegram|admin|info|alert|notify|update|digest|daily|weekly|bulletin|report|travel|—Ç—É—Ä–∏–∑–º|phangan|–∫—É—Ä–æ—Ä—Ç|–æ—Ç–¥—ã—Ö|–æ—Ç–ø—É—Å–∫|—Ç—É—Ä|–≥–∏–¥|—ç–∫—Å–∫—É—Ä—Å/i;
const GROUP_PATTERNS = /group|–≥—Ä—É–ø–ø–∞|chat|—á–∞—Ç|discuss|–¥–∏—Å–∫—É—Å—Å|community|—Å–æ–æ–±—â–µ—Å—Ç–≤–æ/i;

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
 */
export class MessageStorageService {
  private messages: Message[] = [];
  private personalMessagesCache: Map<string, Message[]> = new Map();
  private newsMessagesCache: Map<string, Message[]> = new Map();
  private discussionMessagesCache: Map<string, Message[]> = new Map();
  private chatTypeCache: Map<string, ChatType> = new Map();
  private currentUserId: number | null = null;
  private lastCategorization: number = 0;

  /**
   * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param userId ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  setCurrentUserId(userId: number): void {
    this.currentUserId = userId;
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    this.clearCaches();
  }

  /**
   * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –∫—ç—à–∏
   */
  clearCaches(): void {
    this.personalMessagesCache.clear();
    this.newsMessagesCache.clear();
    this.discussionMessagesCache.clear();
    this.chatTypeCache.clear();
    this.lastCategorization = 0;
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
   * @param messages –ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
   */
  addMessages(messages: Message[]): void {
    this.messages = [...this.messages, ...messages];
    this.clearCaches(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  }

  /**
   * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   */
  recategorizeAllMessages(): void {
    this.clearCaches();
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏
    this.lastCategorization = Date.now();
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∞—Ç –ø—É–±–ª–∏—á–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º –ø–æ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—é
   * @param chatTitle –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
   * @returns true, –µ—Å–ª–∏ —á–∞—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª
   */
  isPublicChannelByName(chatTitle: string | undefined): boolean {
    if (!chatTitle) return false;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —ç–º–æ–¥–∑–∏ —Ñ–ª–∞–≥–æ–≤ (—á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤)
    const hasFlag = /üá¶üá®|üá¶üá©|üá¶üá™|üá¶üá´|üá¶üá¨|üá¶üáÆ|üá¶üá±|üá¶üá≤|üá¶üá¥|üá¶üá∂|üá¶üá∑|üá¶üá∏|üá¶üáπ|üá¶üá∫|üá¶üáº|üá¶üáΩ|üá¶üáø|üáßüá¶|üáßüáß|üáßüá©|üáßüá™|üáßüá´|üáßüá¨|üáßüá≠|üáßüáÆ|üáßüáØ|üáßüá±|üáßüá≤|üáßüá≥|üáßüá¥|üáßüá∂|üáßüá∑|üáßüá∏|üáßüáπ|üáßüáª|üáßüáº|üáßüáæ|üáßüáø|üá®üá¶|üá®üá®|üá®üá©|üá®üá´|üá®üá¨|üá®üá≠|üá®üáÆ|üá®üá∞|üá®üá±|üá®üá≤|üá®üá≥|üá®üá¥|üá®üáµ|üá®üá∑|üá®üá∫|üá®üáª|üá®üáº|üá®üáΩ|üá®üáæ|üá®üáø|üá©üá™|üá©üá¨|üá©üáØ|üá©üá∞|üá©üá≤|üá©üá¥|üá©üáø|üá™üá¶|üá™üá®|üá™üá™|üá™üá¨|üá™üá≠|üá™üá∑|üá™üá∏|üá™üáπ|üá™üá∫|üá´üáÆ|üá´üáØ|üá´üá∞|üá´üá≤|üá´üá¥|üá´üá∑|üá¨üá¶|üá¨üáß|üá¨üá©|üá¨üá™|üá¨üá´|üá¨üá¨|üá¨üá≠|üá¨üáÆ|üá¨üá±|üá¨üá≤|üá¨üá≥|üá¨üáµ|üá¨üá∂|üá¨üá∑|üá¨üá∏|üá¨üáπ|üá¨üá∫|üá¨üáº|üá¨üáæ|üá≠üá∞|üá≠üá≤|üá≠üá≥|üá≠üá∑|üá≠üáπ|üá≠üá∫|üáÆüá®|üáÆüá©|üáÆüá™|üáÆüá±|üáÆüá≤|üáÆüá≥|üáÆüá¥|üáÆüá∂|üáÆüá∑|üáÆüá∏|üáÆüáπ|üáØüá™|üáØüá≤|üáØüá¥|üáØüáµ|üá∞üá™|üá∞üá¨|üá∞üá≠|üá∞üáÆ|üá∞üá≤|üá∞üá≥|üá∞üáµ|üá∞üá∑|üá∞üáº|üá∞üáæ|üá∞üáø|üá±üá¶|üá±üáß|üá±üá®|üá±üáÆ|üá±üá∞|üá±üá∑|üá±üá∏|üá±üáπ|üá±üá∫|üá±üáª|üá±üáæ|üá≤üá¶|üá≤üá®|üá≤üá©|üá≤üá™|üá≤üá´|üá≤üá¨|üá≤üá≠|üá≤üá∞|üá≤üá±|üá≤üá≤|üá≤üá≥|üá≤üá¥|üá≤üáµ|üá≤üá∂|üá≤üá∑|üá≤üá∏|üá≤üáπ|üá≤üá∫|üá≤üáª|üá≤üáº|üá≤üáΩ|üá≤üáæ|üá≤üáø|üá≥üá¶|üá≥üá®|üá≥üá™|üá≥üá´|üá≥üá¨|üá≥üáÆ|üá≥üá±|üá≥üá¥|üá≥üáµ|üá≥üá∑|üá≥üá∫|üá≥üáø|üá¥üá≤|üáµüá¶|üáµüá™|üáµüá´|üáµüá¨|üáµüá≠|üáµüá∞|üáµüá±|üáµüá≤|üáµüá≥|üáµüá∑|üáµüá∏|üáµüáπ|üáµüáº|üáµüáæ|üá∂üá¶|üá∑üá™|üá∑üá¥|üá∑üá∏|üá∑üá∫|üá∑üáº|üá∏üá¶|üá∏üáß|üá∏üá®|üá∏üá©|üá∏üá™|üá∏üá¨|üá∏üá≠|üá∏üáÆ|üá∏üáØ|üá∏üá∞|üá∏üá±|üá∏üá≤|üá∏üá≥|üá∏üá¥|üá∏üá∑|üá∏üá∏|üá∏üáπ|üá∏üáª|üá∏üáΩ|üá∏üáæ|üá∏üáø|üáπüá¶|üáπüá®|üáπüá©|üáπüá´|üáπüá¨|üáπüá≠|üáπüáØ|üáπüá∞|üáπüá±|üáπüá≤|üáπüá≥|üáπüá¥|üáπüá∑|üáπüáπ|üáπüáª|üáπüáº|üáπüáø|üá∫üá¶|üá∫üá¨|üá∫üá≤|üá∫üá≥|üá∫üá∏|üá∫üáæ|üá∫üáø|üáªüá¶|üáªüá®|üáªüá™|üáªüá¨|üáªüáÆ|üáªüá≥|üáªüá∫|üáºüá´|üáºüá∏|üáΩüá∞|üáæüá™|üáæüáπ|üáøüá¶|üáøüá≤|üáøüáº/.test(chatTitle);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
    const hasChannelKeywords = CHANNEL_PATTERNS.test(chatTitle);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª–æ–≤ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
    const hasTravelKeywords = /—á–µ—Ä–Ω–æ–≥–æ—Ä–∏|–ø–∞–Ω–≥–∞–∏|—Ç–∞–∏–ª–∞–Ω–¥|–±–∞–ª–∏|–≤—å–µ—Ç–Ω–∞–º|—Ç—É—Ä—Ü–∏|–∏—Å–ø–∞–Ω–∏|–∏—Ç–∞–ª–∏|–≥—Ä–µ—Ü–∏|–∫–∏–ø—Ä|–¥—É–±–∞–π|–æ–∞—ç|—ç–º–∏—Ä–∞—Ç|–µ–≥–∏–ø–µ—Ç|–∏–Ω–¥–æ–Ω–µ–∑–∏|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—è–ø–æ–Ω–∏|–∫–æ—Ä–µ—è|–∫–∏—Ç–∞–π|–≥–æ–Ω–∫–æ–Ω–≥|–º–∞–∫–∞–æ|—Ç–∞–π–≤–∞–Ω—å|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–∫–∞–º–±–æ–¥–∂|–ª–∞–æ—Å|–º—å—è–Ω–º–∞|–Ω–µ–ø–∞–ª|–∏–Ω–¥–∏—è|—à—Ä–∏-–ª–∞–Ω–∫–∞|–º–∞–ª—å–¥–∏–≤|—Å–µ–π—à–µ–ª|–º–∞–≤—Ä–∏–∫–∏–π|–∑–∞–Ω–∑–∏–±–∞—Ä|—Ç–∞–Ω–∑–∞–Ω–∏—è|–∫–µ–Ω–∏—è|–º–∞—Ä–æ–∫–∫–æ|—Ç—É–Ω–∏—Å|–∞–ª–∂–∏—Ä|–ª–∏–≤–∏—è|–µ–≥–∏–ø–µ—Ç|–∏–æ—Ä–¥–∞–Ω–∏—è|–∏–∑—Ä–∞–∏–ª—å|–ª–∏–≤–∞–Ω|—Å–∏—Ä–∏—è|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|—Å–∞—É–¥–æ–≤—Å–∫–∞—è –∞—Ä–∞–≤–∏—è|–∫–∞—Ç–∞—Ä|–±–∞—Ö—Ä–µ–π–Ω|–æ–º–∞–Ω|–π–µ–º–µ–Ω|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–±—É—Ç–∞–Ω|–º—å—è–Ω–º–∞|—Ç–∞–∏–ª–∞–Ω–¥|–ª–∞–æ—Å|–∫–∞–º–±–æ–¥–∂–∞|–≤—å–µ—Ç–Ω–∞–º|–º–∞–ª–∞–π–∑–∏—è|—Å–∏–Ω–≥–∞–ø—É—Ä|–∏–Ω–¥–æ–Ω–µ–∑–∏—è|–±—Ä—É–Ω–µ–π|—Ñ–∏–ª–∏–ø–ø–∏–Ω—ã|—Ç–∞–π–≤–∞–Ω—å|–∫–∏—Ç–∞–π|–º–æ–Ω–≥–æ–ª–∏—è|—Å–µ–≤–µ—Ä–Ω–∞—è –∫–æ—Ä–µ—è|—é–∂–Ω–∞—è –∫–æ—Ä–µ—è|—è–ø–æ–Ω–∏—è|—Ä–æ—Å—Å–∏—è|—É–∫—Ä–∞–∏–Ω–∞|–±–µ–ª–∞—Ä—É—Å—å|–º–æ–ª–¥–æ–≤–∞|—Ä—É–º—ã–Ω–∏—è|–±–æ–ª–≥–∞—Ä–∏—è|—Å–µ—Ä–±–∏—è|—á–µ—Ä–Ω–æ–≥–æ—Ä–∏—è|–±–æ—Å–Ω–∏—è –∏ –≥–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞|—Ö–æ—Ä–≤–∞—Ç–∏—è|—Å–ª–æ–≤–µ–Ω–∏—è|–≤–µ–Ω–≥—Ä–∏—è|–∞–≤—Å—Ç—Ä–∏—è|—á–µ—Ö–∏—è|—Å–ª–æ–≤–∞–∫–∏—è|–ø–æ–ª—å—à–∞|–ª–∏—Ç–≤–∞|–ª–∞—Ç–≤–∏—è|—ç—Å—Ç–æ–Ω–∏—è|—Ñ–∏–Ω–ª—è–Ω–¥–∏—è|—à–≤–µ—Ü–∏—è|–Ω–æ—Ä–≤–µ–≥–∏—è|–¥–∞–Ω–∏—è|–∏—Å–ª–∞–Ω–¥–∏—è|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è|–∏—Ä–ª–∞–Ω–¥–∏—è|—Ñ—Ä–∞–Ω—Ü–∏—è|–±–µ–ª—å–≥–∏—è|–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã|–ª—é–∫—Å–µ–º–±—É—Ä–≥|–≥–µ—Ä–º–∞–Ω–∏—è|—à–≤–µ–π—Ü–∞—Ä–∏—è|–ª–∏—Ö—Ç–µ–Ω—à—Ç–µ–π–Ω|–∏—Ç–∞–ª–∏—è|–≤–∞—Ç–∏–∫–∞–Ω|—Å–∞–Ω-–º–∞—Ä–∏–Ω–æ|–º–∞–ª—å—Ç–∞|–∏—Å–ø–∞–Ω–∏—è|–ø–æ—Ä—Ç—É–≥–∞–ª–∏—è|–∞–Ω–¥–æ—Ä—Ä–∞|–º–æ–Ω–∞–∫–æ|–≥—Ä–µ—Ü–∏—è|–∞–ª–±–∞–Ω–∏—è|—Å–µ–≤–µ—Ä–Ω–∞—è –º–∞–∫–µ–¥–æ–Ω–∏—è|–∫–æ—Å–æ–≤–æ|—á–µ—Ä–Ω–æ–≥–æ—Ä–∏—è|—Å–µ—Ä–±–∏—è|–±–æ—Å–Ω–∏—è –∏ –≥–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞|—Ö–æ—Ä–≤–∞—Ç–∏—è|—Å–ª–æ–≤–µ–Ω–∏—è|–∫–∏–ø—Ä|—Ç—É—Ä—Ü–∏—è|–≥—Ä—É–∑–∏—è|–∞—Ä–º–µ–Ω–∏—è|–∞–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω|–∫–∞–∑ÔøΩÔøΩ—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|—Ç—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω|–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω|—Ç–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–ø–∞–∫–∏—Å—Ç–∞–Ω|–∏–Ω–¥–∏—è|–Ω–µ–ø–∞–ª|–±—É—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|—à—Ä–∏-–ª–∞–Ω–∫–∞|–º–∞–ª—å–¥–∏–≤—ã|—Å–µ–π—à–µ–ª—ã|–º–∞–≤—Ä–∏–∫–∏–π|–∫–æ–º–æ—Ä—ã|–º–∞–¥–∞–≥–∞—Å–∫–∞—Ä|—Ç–∞–Ω–∑–∞–Ω–∏—è|–∫–µ–Ω–∏—è|—É–≥–∞–Ω–¥–∞|—Ä—É–∞–Ω–¥–∞|–±—É—Ä—É–Ω–¥–∏|–∫–æ–Ω–≥–æ|–∞–Ω–≥–æ–ª–∞|–Ω–∞–º–∏–±–∏—è|–±–æ—Ç—Å–≤–∞–Ω–∞|–∑–∏–º–±–∞–±–≤–µ|–∑–∞–º–±–∏—è|–º–∞–ª–∞–≤–∏|–º–æ–∑–∞–º–±–∏–∫|—Å–≤–∞–∑–∏–ª–µ–Ω–¥|–ª–µ—Å–æ—Ç–æ|—é–∂–Ω–∞—è –∞—Ñ—Ä–∏–∫–∞|–º–∞—Ä–æ–∫–∫–æ|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏—è|–µ–≥–∏–ø–µ—Ç|—Å—É–¥–∞–Ω|—ç—Ä–∏—Ç—Ä–µ—è|—ç—Ñ–∏–æ–ø–∏—è|–¥–∂–∏–±—É—Ç–∏|—Å–æ–º–∞–ª–∏|–∫–µ–Ω–∏—è|—É–≥–∞–Ω–¥–∞|—Ä—É–∞–Ω–¥–∞|–±—É—Ä—É–Ω–¥–∏|—Ç–∞–Ω–∑–∞–Ω–∏—è|–º–æ–∑–∞–º–±–∏–∫|–º–∞–ª–∞–≤–∏|–∑–∞–º–±–∏—è|–∑–∏–º–±–∞–±–≤–µ|–±–æ—Ç—Å–≤–∞–Ω–∞|–Ω–∞–º–∏–±–∏—è|–∞–Ω–≥–æ–ª–∞|–∫–æ–Ω–≥–æ|–≥–∞–±–æ–Ω|—ç–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –≥–≤–∏–Ω–µ—è|–∫–∞–º–µ—Ä—É–Ω|–Ω–∏–≥–µ—Ä–∏—è|–±–µ–Ω–∏–Ω|—Ç–æ–≥–æ|–≥–∞–Ω–∞|–∫–æ—Ç-–¥'–∏–≤—É–∞—Ä|–ª–∏–±–µ—Ä–∏—è|—Å—å–µ—Ä—Ä–∞-–ª–µ–æ–Ω–µ|–≥–≤–∏–Ω–µ—è|–≥–≤–∏–Ω–µ—è-–±–∏—Å–∞—É|—Å–µ–Ω–µ–≥–∞–ª|–≥–∞–º–±–∏—è|–∫–∞–±–æ-–≤–µ—Ä–¥–µ|–º–∞–≤—Ä–∏—Ç–∞–Ω–∏—è|–º–∞–ª–∏|–±—É—Ä–∫–∏–Ω–∞-—Ñ–∞—Å–æ|–Ω–∏–≥–µ—Ä|—á–∞–¥|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–∞—Ñ—Ä–∏–∫–∞–Ω—Å–∫–∞—è —Ä–µ—Å–ø—É–±–ª–∏–∫–∞|—é–∂–Ω—ã–π —Å—É–¥–∞–Ω|—ç—Ñ–∏–æ–ø–∏—è|—ç—Ä–∏—Ç—Ä–µ—è|–¥–∂–∏–±—É—Ç–∏|—Å–æ–º–∞–ª–∏|–∫–µ–Ω–∏—è|—Ç–∞–Ω–∑–∞–Ω–∏—è|—É–≥–∞–Ω–¥–∞|—Ä—É–∞–Ω–¥–∞|–±—É—Ä—É–Ω–¥–∏|–∫–æ–Ω–≥–æ|–∞–Ω–≥–æ–ª–∞|–∑–∞–º–±–∏—è|–∑–∏–º–±–∞–±–≤–µ|–º–æ–∑–∞–º–±–∏–∫|–º–∞–ª–∞–≤–∏|–∫–æ–º–æ—Ä—ã|—Å–µ–π—à–µ–ª—ã|–º–∞–≤—Ä–∏–∫–∏–π|–º–∞–¥–∞–≥–∞—Å–∫–∞—Ä|—Ä–µ—é–Ω—å–æ–Ω|–º–∞–π–æ—Ç—Ç–∞|–∫–∞–Ω–∞–¥–∞|—Å—à–∞|–º–µ–∫—Å–∏–∫–∞|–≥–≤–∞—Ç–µ–º–∞–ª–∞|–±–µ–ª–∏–∑|—Å–∞–ª—å–≤–∞–¥–æ—Ä|–≥–æ–Ω–¥—É—Ä–∞—Å|–Ω–∏–∫–∞—Ä–∞–≥—É–∞|–∫–æ—Å—Ç–∞-—Ä–∏–∫–∞|–ø–∞–Ω–∞–º–∞|–∫–æ–ª—É–º–±–∏—è|–≤–µ–Ω–µ—Å—É—ç–ª–∞|–≥–∞–π–∞–Ω–∞|—Å—É—Ä–∏–Ω–∞–º|—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –≥–≤–∏–∞–Ω–∞|–±—Ä–∞–∑–∏–ª–∏—è|–ø–µ—Ä—É|—ç–∫–≤–∞–¥–æ—Ä|–±–æ–ª–∏–≤–∏—è|–ø–∞—Ä–∞–≥–≤–∞–π|—á–∏–ª–∏|–∞—Ä–≥–µ–Ω—Ç–∏–Ω–∞|—É—Ä—É–≥–≤–∞–π|—Ñ–æ–ª–∫–ª–µ–Ω–¥—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞|–∞–≤—Å—Ç—Ä–∞–ª–∏—è|–Ω–æ–≤–∞—è –∑–µ–ª–∞–Ω–¥–∏—è|–ø–∞–ø—É–∞-–Ω–æ–≤–∞—è –≥–≤–∏–Ω–µ—è|—Å–æ–ª–æ–º–æ–Ω–æ–≤—ã –æ—Å—Ç—Ä–æ–≤–∞|–≤–∞–Ω—É–∞—Ç—É|—Ñ–∏–¥–∂–∏|—Ç–æ–Ω–≥–∞|—Å–∞–º–æ–∞|–∫–∏—Ä–∏–±–∞—Ç–∏|—Ç—É–≤–∞–ª—É|–Ω–∞—É—Ä—É|–º–∞—Ä—à–∞–ª–ª–æ–≤—ã –æ—Å—Ç—Ä–æ–≤–∞|—Ñ–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ —à—Ç–∞—Ç—ã –º–∏–∫—Ä–æ–Ω–µ–∑–∏–∏|–ø–∞–ª–∞—É|–≥—É–∞–º|—Å–µ–≤–µ—Ä–Ω—ã–µ –º–∞—Ä–∏–∞–Ω—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞|–∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–µ —Å–∞–º–æ–∞|—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –ø–æ–ª–∏–Ω–µ–∑–∏—è|–Ω–æ–≤–∞—è –∫–∞–ª–µ–¥–æ–Ω–∏—è|—É–æ–ª–ª–∏—Å –∏ —Ñ—É—Ç—É–Ω–∞|—Ç–æ–∫–µ–ª–∞—É|–Ω–∏—É—ç|–æ—Å—Ç—Ä–æ–≤–∞ –∫—É–∫–∞|–ø–∏—Ç–∫—ç—Ä–Ω|–∞–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞/.test(chatTitle.toLowerCase());
    
    return hasFlag || hasChannelKeywords || hasTravelKeywords;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —á–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
   * @param chat –û–±—ä–µ–∫—Ç —á–∞—Ç–∞
   * @param message –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞
   * @returns –¢–∏–ø —á–∞—Ç–∞
   */
  determineChatType(chat: Chat, message: Message): ChatType {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const chatId = chat.id.toString();
    if (this.chatTypeCache.has(chatId)) {
      return this.chatTypeCache.get(chatId) as ChatType;
    }

    let chatType = ChatType.UNKNOWN;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª –∏–ª–∏ –±–æ—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    if (chat.title && this.isPublicChannelByName(chat.title)) {
      chatType = ChatType.NEWS;
      this.chatTypeCache.set(chatId, chatType);
      return chatType;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    if (chat.title && GROUP_PATTERNS.test(chat.title)) {
      chatType = ChatType.DISCUSSION;
      this.chatTypeCache.set(chatId, chatType);
      return chatType;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∏—á–Ω—ã–π —á–∞—Ç (–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
    if (chat._ === 'user') {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –Ω–µ –±–æ—Ç
      if ((chat as any).bot) {
        chatType = ChatType.NEWS;
      } else {
        chatType = ChatType.PERSONAL;
      }
    } 
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∏—á–Ω—ã–π —á–∞—Ç (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —á–∏—Å–ª–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
    else if (chat._ === 'chat' && chat.participants_count === 2) {
      chatType = ChatType.PERSONAL;
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª (–Ω–æ–≤–æ—Å—Ç–Ω–æ–π)
    else if (
      chat._ === 'channel' || 
      chat._ === 'channelFull' ||
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –æ–±—â–µ–Ω–∏—è
      (message && message.from_id && message.from_id._ === 'peerChannel')
    ) {
      chatType = ChatType.NEWS;
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç (–¥–∏—Å–∫—É—Å—Å–∏—è)
    else if (
      chat._ === 'chat' || 
      chat._ === 'chatFull' ||
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–Ω–æ–≥–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –æ–±—â–µ–Ω–∏–µ
      (chat.participants_count && chat.participants_count > 2)
    ) {
      chatType = ChatType.DISCUSSION;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    this.chatTypeCache.set(chatId, chatType);
    return chatType;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º
   * @param message –°–æ–æ–±—â–µ–Ω–∏–µ
   * @returns true, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–∏—á–Ω–æ–µ
   */
  isPersonalMessage(message: Message): boolean {
    if (!this.currentUserId) {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–º–µ–µ—Ç peer_id
    if (!message.peer_id) return false;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–∞–Ω–∞–ª –∏ –Ω–µ –≥—Ä—É–ø–ø–∞
    if (message.peer_id._ === 'peerChannel' || message.peer_id._ === 'peerChat') {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    if (message.peer_id._ === 'peerUser') {
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
      const chat = message.peerId as unknown as Chat;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –±–æ—Ç
      if (chat && chat._ === 'user' && (chat as any).bot) {
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∫–∞–Ω–∞–ª–æ–≤/–±–æ—Ç–æ–≤
      if (chat && chat.title && this.isPublicChannelByName(chat.title)) {
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é
      const fromUserId = message.from_id && message.from_id._ === 'peerUser' 
        ? (message.from_id as any).user_id 
        : null;
      
      const toUserId = message.peer_id.user_id;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–∏–±–æ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ª–∏–±–æ –∫ –Ω–µ–º—É
      const isCurrentUserInvolved = 
        fromUserId === this.currentUserId || 
        toUserId === this.currentUserId;
      
      if (!isCurrentUserInvolved) {
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
      if (chat) {
        const chatType = this.determineChatType(chat, message);
        return chatType === ChatType.PERSONAL;
      }

      return true;
    }

    return false;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   * @returns –ú–∞—Å—Å–∏–≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   */
  getPersonalMessages(): Message[] {
    if (!this.currentUserId) {
      console.warn('Current user ID is not set');
      return [];
    }

    const cacheKey = 'personal';
    if (this.personalMessagesCache.has(cacheKey) && this.lastCategorization > 0) {
      return this.personalMessagesCache.get(cacheKey) || [];
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
    const personalMessages = this.messages.filter(message => {
      // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (!this.isPersonalMessage(message)) {
        return false;
      }

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —á–∞—Ç–∞
      const chat = message.peerId as unknown as Chat;
      if (chat) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        if (chat.title && this.isPublicChannelByName(chat.title)) {
          return false;
        }
        
        return this.verifyMessageCategory(message, ChatType.PERSONAL);
      }

      return true;
    });

    this.personalMessagesCache.set(cacheKey, personalMessages);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    if (this.lastCategorization === 0) {
      this.lastCategorization = Date.now();
    }
    
    return personalMessages;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   * @returns –ú–∞—Å—Å–∏–≤ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   */
  getNewsMessages(): Message[] {
    const cacheKey = 'news';
    if (this.newsMessagesCache.has(cacheKey) && this.lastCategorization > 0) {
      return this.newsMessagesCache.get(cacheKey) || [];
    }

    const newsMessages = this.messages.filter(message => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–º–µ–µ—Ç peer_id
      if (!message.peer_id) return false;

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
      const chat = message.peerId as unknown as Chat;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
      if (chat && chat.title && this.isPublicChannelByName(chat.title)) {
        return true;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∫–∞–Ω–∞–ª –∏–ª–∏ –±–æ—Ç
      if (message.peer_id._ === 'peerChannel' || 
          (message.peer_id._ === 'peerUser' && chat && chat._ === 'user' && (chat as any).bot)) {
        return this.verifyMessageCategory(message, ChatType.NEWS);
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∫–∞–Ω–∞–ª–æ–≤/–±–æ—Ç–æ–≤
      if (chat && chat.title && CHANNEL_PATTERNS.test(chat.title)) {
        return true;
      }

      return false;
    });

    this.newsMessagesCache.set(cacheKey, newsMessages);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    if (this.lastCategorization === 0) {
      this.lastCategorization = Date.now();
    }
    
    return newsMessages;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –¥–∏—Å–∫—É—Å—Å–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   * @returns –ú–∞—Å—Å–∏–≤ –¥–∏—Å–∫—É—Å—Å–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   */
  getDiscussionMessages(): Message[] {
    const cacheKey = 'discussion';
    if (this.discussionMessagesCache.has(cacheKey) && this.lastCategorization > 0) {
      return this.discussionMessagesCache.get(cacheKey) || [];
    }

    const discussionMessages = this.messages.filter(message => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–º–µ–µ—Ç peer_id
      if (!message.peer_id) return false;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≥—Ä—É–ø–ø–∞ –∏–ª–∏ –∫–∞–Ω–∞–ª —Å –¥–∏—Å–∫—É—Å—Å–∏–µ–π
      if (message.peer_id._ === 'peerChat' || message.peer_id._ === 'peerChannel') {
        const chat = message.peerId as unknown as Chat;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
        if (chat && chat.title && this.isPublicChannelByName(chat.title)) {
          return false; // –≠—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª, –Ω–µ –¥–∏—Å–∫—É—Å—Å–∏—è
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≥—Ä—É–ø–ø
        if (chat && chat.title && GROUP_PATTERNS.test(chat.title)) {
          return true;
        }
        
        return this.verifyMessageCategory(message, ChatType.DISCUSSION);
      }

      return false;
    });

    this.discussionMessagesCache.set(cacheKey, discussionMessages);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    if (this.lastCategorization === 0) {
      this.lastCategorization = Date.now();
    }
    
    return discussionMessages;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
   * @returns –û–±—ä–µ–∫—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
   */
  getGroupedMessagesByCategory(): { 
    personal: Message[], 
    news: Message[], 
    discussion: Message[] 
  } {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—É—é –ª–æ–≥–∏–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
    return {
      personal: this.getPersonalMessages(),
      news: this.getNewsMessages(),
      discussion: this.getDiscussionMessages()
    };
  }

  /**
   * –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   * @param message –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param category –ö–∞—Ç–µ–≥–æ—Ä–∏—è
   * @returns true, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   */
  verifyMessageCategory(message: Message, category: ChatType): boolean {
    if (!message.peer_id) return false;

    const chat = message.peerId as unknown as Chat;
    if (!chat) return false;

    // –î–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (category === ChatType.PERSONAL) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –±–æ—Ç
      if (chat._ === 'user' && (chat as any).bot) {
        return false;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–∞–Ω–∞–ª–æ–≤/–±–æ—Ç–æ–≤
      if (chat.title && this.isPublicChannelByName(chat.title)) {
        return false;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é
      if (this.currentUserId) {
        const fromUserId = message.from_id && message.from_id._ === 'peerUser' 
          ? (message.from_id as any).user_id 
          : null;
        
        const toUserId = message.peer_id._ === 'peerUser' 
          ? message.peer_id.user_id 
          : null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–∏–±–æ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ª–∏–±–æ –∫ –Ω–µ–º—É
        const isCurrentUserInvolved = 
          fromUserId === this.currentUserId || 
          toUserId === this.currentUserId;
        
        if (!isCurrentUserInvolved) {
          return false;
        }
      }
    }

    // –ü–æ–ª—É—á–∞–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞
    const chatType = this.determineChatType(chat, message);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    return chatType === category;
  }
}